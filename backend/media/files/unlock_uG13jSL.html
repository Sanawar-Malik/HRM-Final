{% extends "base.html" %}
{% block content %}

<style>
.scroll-container {
  height: 80vh;
  overflow-y: auto;
  margin-top: 8px;
  position: relative;
}
.scroll-container::-webkit-scrollbar { width: 8px; }
.scroll-container::-webkit-scrollbar-thumb {
  background-color: #888;
  border-radius: 4px;
}
.scroll-container::-webkit-scrollbar-track {
  background-color: transparent;
}
</style>

<div id="aMsg" class="uk-alert-danger uk-hidden" uk-alert>
  <p id="pMsg" name="pMsg"></p>
</div>

<div uk-grid>
  <div>
    <select class="uk-select" id="eseal_id" name="eseal_id">
      <option value="-1">Select Eseal ID..</option>
      <option value="es_1">ES-1</option>
    </select>
  </div>
  <div class="uk-width-auto@m">
    <input type="button" value="Status" class="uk-button uk-button-primary" id="btnGenerate">
  </div>
</div>

<div class="uk-hidden" uk-spinner="ratio: 10" id="spinner"
     style="position: fixed; top: 50%; z-index:999; left: 50%; transform: translate(-50%, -50%); text-align: center;">
</div>

<h2 class="uk-heading uk-text-bolder" style="text-decoration: underline;">Eseal Status Report:</h2>

<div class="scroll-container">
  <table id="tblEseal" class="uk-table uk-table-striped uk-table-hover uk-hidden">
    <thead>
      <tr>
        <th>Sr#</th>
        <th>Eseal ID</th>
        <th>Status</th>
        <th>DateTime</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tbdEseal"></tbody>
  </table>
</div>

<script>
$(document).ready(function () {
    $('#btnGenerate').click(function () {
        $("#tblEseal").addClass("uk-hidden");
        $("#aMsg").addClass("uk-hidden");
        $("#spinner").removeClass("uk-hidden");

        const eseal_id = $('#eseal_id').val();

        if (eseal_id === "-1") {
            $("#spinner").addClass("uk-hidden");
            $("#aMsg").removeClass("uk-hidden").find("#pMsg").text("Please select a valid Eseal ID.");
            return;
        }

        $.ajax({
            url: "/eseal/getEsealStatus",
            type: "POST",
            dataType: "json",
            data: { eseal_id: eseal_id },
            success: function (response) {
                $("#spinner").addClass("uk-hidden");

                const eseal = response.Eseals;

                if (eseal && eseal.eseal_id) {
                    const actionBtn = eseal.status === "close"
                        ? `<button class='uk-button' style="background-color: #368690; color: white; onclick='handleEsealOpen("${eseal.eseal_id}")'>Open</button>`
                        : `<button class='uk-button' style="background-color: #4b536d; color:white" disabled>Close</button>`;

                    const row = `
                        <tr>
                            <td>1</td>
                            <td>${eseal.eseal_id}</td>
                            <td>${eseal.status}</td>
                            <td>${eseal.created_at}</td>
                            <td>${actionBtn}</td>
                        </tr>`;

                    $("#tbdEseal").html(row);
                } else {
                    $("#tbdEseal").html("<tr><td colspan='5' style='text-align:center;'><h3>No Data Found</h3></td></tr>");
                }

                $("#tblEseal").removeClass("uk-hidden");
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error: ", status, error);
                $("#spinner").addClass("uk-hidden");
                $("#tbdEseal").html("<tr><td colspan='5' style='text-align:center;'><h3>Error fetching data</h3></td></tr>");
                $("#tblEseal").removeClass("uk-hidden");
            }
        });
    });
});

    window.handleEsealOpen = function (eseal_id) {
        $.ajax({
            url: "/eseal/actionOpen",
            type: "POST",
            dataType: "json",
            data: { eseal_id: eseal_id, command:"open" },
            success: function (response) {
                // alert("Eseal opened successfully!");
                $('#btnGenerate').click();  // Refresh table
            },
            error: function (xhr, status, error) {
                console.error("Error opening eseal:", error);
                alert("Error opening eseal.");
            }
        });
    };
</script>

{% end %}

